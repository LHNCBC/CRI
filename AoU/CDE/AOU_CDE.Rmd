---
title: "All of US Common Data Elements"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes

---
*Craig Mayer, Nick Williams, Vojtech Huser*  
*Lister Hill National Center for Biomedical Communications, National Library of Medicine, NIH, Bethesda, MD*


This report contains a subset of data elements and permissable values. For the complete set visit the project repository  at https://github.com/lhncbc/CRI/tree/master/AoU/CDE

---

```{r DataLoad, message=FALSE, echo=FALSE}
#Load Libraries
library(dplyr)
library(tidyverse)
library(stringr)
library(readr)
library(DT)
#Load concept and workbench extract and combine
aou_concept <- readRDS("aou_concept2.rds")
achillies0 <- readRDS("achillies2_09DEC20.rds")
achillies2<-left_join(achillies0 , aou_concept,by=c('stratum_1'='concept_id'))
achillies3<-left_join(achillies2 , aou_concept,by=c('stratum_2'='concept_id'))
achillies4<- achillies3 %>% select(,c(1:7,12:14, 16,19:20,22,25))
```


```{r code, message=FALSE, echo=FALSE}

#Filter by analysis type
achillies4_cnt<-achillies4%>%filter(a_type=='cnt')
achillies4_cnt2<-achillies4%>%filter(a_type=='cnt2')

#CObine to have value and test counts in same rows
achillies5<-left_join(achillies4_cnt2, achillies4_cnt, by =c('a_table', "stratum_1"))

#Remove source value columns
achillies6<-achillies5%>%filter(!grepl("source",a_column.y))
achillies7<-achillies6%>%filter(!grepl("type",a_column.y))

# Proportion of value count to test count
achillies7$proportion_of_values<-achillies7$count_value.x/achillies7$count_value.y


# Repeat with participant counts
achillies4_cntpt<-achillies4%>%filter(a_type=='cntpt')
achillies4_cnt2pt<-achillies4%>%filter(a_type=='cnt2pt')
achillies5pt<-left_join(achillies4_cnt2pt, achillies4_cntpt, by =c('a_table', "stratum_1"))
achillies6pt<-achillies5pt%>%filter(!grepl("source",a_column.y))
achillies7pt<-achillies6pt%>%filter(!grepl("type",a_column.y))
achillies7pt$proportion_of_values<-achillies7pt$count_value.x/achillies7pt$count_value.y

#Combine overall counts with participant counts
achillies8<-left_join(achillies7,achillies7pt, by=c('a_table', 'stratum_1', 'stratum_2.x') )
achillies9<-achillies8%>%select(,c(1:2,5:6,10:15, 4,18, 29, 32,44,55))
colnames(achillies9)<-c('a_table', 'a_column', 
                        'test_concept_id', 'value_conceppt_id', 'test_concept_name', 'test_vocabulary_id', 'test_code',
                        'value_concept_name', 'value_vocabulary_id', 'value_code',
                        'count_value', 'count_test','percent', 'pt_count_value', 'pt_count_test','pt_percent')

#Total participants
person<-achillies4%>%filter(a_table=='person')
patients<-person$count_value
achillies9$per_total_pt<-achillies9$pt_count_test/patients

#Comparison of DE and value vocabularies
achillies9$vocab_equivalent<-achillies9$test_vocabulary_id==achillies9$value_vocabulary_id



# Distinct DE  counts by vocabualry  by table
distinct_concepts<-achillies4_cnt%>%group_by(a_table,a_column,vocabulary_id.x)%>%count()
distinct_concepts2<-distinct_concepts%>% filter(a_table=='measurement'|a_table=='observation')
distinct_concepts3<-distinct_concepts2%>% filter(a_column=='measurement_concept_id'|a_column=='observation_concept_id')
colnames(distinct_concepts3)<-c('Table', 'column', 'Vocabulary', 'Distinct_test_concepts')

# Total DEs in tables
tbl_distinct_concepts<-achillies4_cnt%>%group_by(a_table,a_column)%>%count()
distinct_values<-achillies4_cnt2%>%group_by(stratum_2)%>%count()


# DE Concepts by vocab
distinct_concepts4<-left_join(distinct_concepts3, tbl_distinct_concepts, by =c('Table'='a_table','column'='a_column'))
distinct_concepts4$DE_percentage<-distinct_concepts4$Distinct_test_concepts/distinct_concepts4$n
colnames(distinct_concepts4)[5]<-'tbl_DEs_cnt'
distinct_concepts5<-distinct_concepts4[with(distinct_concepts4, order(Table, -DE_percentage)),]



#S1-DE overview
pvs_de<-achillies9%>%group_by(a_table, test_concept_id)%>%count()
vocab_pvs_de<-achillies9%>%group_by(a_table, test_concept_id, value_vocabulary_id)%>%count()
vocab_pvs_de2<-vocab_pvs_de%>%group_by(a_table, test_concept_id)%>%count()
vocab_pvs_de3<-left_join(vocab_pvs_de2,aou_concept, by=c('test_concept_id' = 'concept_id') )%>%select(1:4, 6)
colnames(vocab_pvs_de3)<-c('Table', 'test_concept_id', 'PV_vocabs_used', 'test_name', 'test_vocab')

#PV Vocab usage
full_pvs<-left_join(vocab_pvs_de3,pvs_de, by =c('test_concept_id' ,'Table'='a_table'))
colnames(full_pvs)[6]<-'Distinct_PVs'
colnames(full_pvs)[3]<-'PV_vocabs_used'
vocab_pvs_de<-vocab_pvs_de%>%arrange(-n)

#S1-concitnuation
pv_vocabs_coll<-aggregate(vocab_pvs_de, list(vocab_pvs_de$a_table,vocab_pvs_de$test_concept_id), paste, collapse="|")
full_pvs2<-left_join(full_pvs, pv_vocabs_coll, by=c('Table'='Group.1', 'test_concept_id'='Group.2'))%>%select(,c(1:6,9,10))
full_pvs2$pv_de_vocab_match<-full_pvs2$test_vocab==full_pvs2$value_vocabulary_id
colnames(full_pvs2)[9]<-'DEs_by_vocab'
test_level<-achillies9 [!duplicated(achillies9[c('a_table','a_column', 'test_concept_id')]),]
full_pvs3<-left_join(full_pvs2, test_level, by=c('Table'='a_table', 'test_concept_id'))%>%select(,c(2:10,15,20,23,25))
full_pvs3<-full_pvs3%>%arrange(-per_total_pt)



pv_over<-aggregate(achillies9$count_value, by=list(value_conceppt_id=achillies9$value_conceppt_id), FUN=sum)
pv_over2<-left_join(pv_over, aou_concept,by=c('value_conceppt_id'= 'concept_id'))%>%select(,c(1:3,5,8))
colnames(pv_over2)[2]<-'count_value'
pv_over2<-pv_over2[with(pv_over2, order( -count_value)),]

# Write files
S1<-full_pvs3%>%filter(pt_count_test>19)
S1_2<-S1[,c(2:14)]
S1_2 %>% write_csv('S1_AOU_DE.csv')

S2<-achillies9%>%filter(pt_count_value>19 )
S2_1<-S2%>%arrange(-pt_count_test)
S2_1 %>% write_csv('S2_AOU_DE-PV_combinations.csv')


```

# Complete set of Data Eleements
## S1-Data Elements
### Measurement DEs
```{r S1-ms, message=FALSE, echo=FALSE}
full_pvs4<-full_pvs3%>%filter(pt_count_test>19& Table =='measurement')
full_pvs4<-full_pvs4%>%arrange(-pt_count_test)
full_pvs5<-full_pvs4[1:4000,c(2:14)]
full_pvs5 %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```

### Measurement DE Terminologies
```{r T2-ms, message=FALSE, echo=FALSE}
library(knitr)
distinct<-distinct_concepts5%>% filter(Table == 'measurement')%>%select(,c(3:4,6))
colnames(distinct)<-c('Vocabulary_id', 'DE_count', 'Table_DE_proportion')
kable(distinct)
```


### Observation DEs
```{r S1-obs, message=FALSE, echo=FALSE}
full_pvs4<-full_pvs3%>%filter(pt_count_test>19& Table =='observation')
full_pvs4<-full_pvs4%>%arrange(-pt_count_test)
full_pvs5<-full_pvs4[1:4000,c(2:14)]
full_pvs5 %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```


### Observation DE Terminologies
```{r T2-obs, message=FALSE, echo=FALSE}
library(knitr)
distinct<-distinct_concepts5%>% filter(Table == 'observation')%>%select(,c(3:4,6))
colnames(distinct)<-c('Vocabulary_id', 'DE_count', 'Table_DE_proportion')
kable(distinct)
```


## S2-Data Element - Permissable Value Combinations
### Measurement DE-PV combinations
```{r S2-m, message=FALSE, echo=FALSE}
achillies99<-achillies9%>%filter(pt_count_value>19 & a_table =='measurement')
achillies99<-achillies99%>%arrange(-pt_count_test)
achillies991<-achillies99[1:4000,]

achillies991 %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```


### Observation DE-PV Combinations
``````{r S2-o, message=FALSE, echo=FALSE}
achillies99<-achillies9%>%filter(pt_count_value>19 & a_table =='observation')
achillies99<-achillies99%>%arrange(-pt_count_test)
achillies991<-achillies99[1:4000,]

achillies991 %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```



```{r codePPI, message=FALSE, echo=FALSE}
# For just PPI Data
#Load concept and workbench extract and combine

#Filter by analysis type
achillies4_cnt<-achillies4%>%filter(a_type=='cntSrc' & src == 'PPI/PM')
achillies4_cnt2<-achillies4%>%filter(a_type=='cnt2Src'& src == 'PPI/PM')

#CObine to have value and test counts in same rows
achillies5<-left_join(achillies4_cnt2, achillies4_cnt, by =c('a_table', "stratum_1"))

#Remove source value columns
achillies6<-achillies5%>%filter(!grepl("source",a_column.y))
achillies7<-achillies6%>%filter(!grepl("type",a_column.y))

# Proportion of value count to test count
achillies7$proportion_of_values<-achillies7$count_value.x/achillies7$count_value.y


# Repeat with participant counts
achillies4_cntpt<-achillies4%>%filter(a_type=='cntpt')
achillies4_cnt2pt<-achillies4%>%filter(a_type=='cnt2pt')
achillies5pt<-left_join(achillies4_cnt2pt, achillies4_cntpt, by =c('a_table', "stratum_1"))
achillies6pt<-achillies5pt%>%filter(!grepl("source",a_column.y))
achillies7pt<-achillies6pt%>%filter(!grepl("type",a_column.y))
achillies7pt$proportion_of_values<-achillies7pt$count_value.x/achillies7pt$count_value.y

#Combine overall counts with participant counts
achillies8<-left_join(achillies7,achillies7pt, by=c('a_table', 'stratum_1', 'stratum_2.x') )
achillies9<-achillies8%>%select(,c(1:2,5:6,10:15, 4,18, 29, 32,44,55))
colnames(achillies9)<-c('a_table', 'a_column', 
                        'test_concept_id', 'value_conceppt_id', 'test_concept_name', 'test_vocabulary_id', 'test_code',
                        'value_concept_name', 'value_vocabulary_id', 'value_code',
                        'count_value', 'count_test','percent', 'pt_count_value', 'pt_count_test','pt_percent')

#Total participants
person<-achillies4%>%filter(a_table=='person')
patients<-person$count_value
achillies9$per_total_pt<-achillies9$pt_count_test/patients

#Comparison of DE and value vocabularies
achillies9$vocab_equivalent<-achillies9$test_vocabulary_id==achillies9$value_vocabulary_id



# Distinct DE  counts by vocabualry  by table
distinct_concepts21<-achillies4_cnt%>% filter(a_column=='measurement_concept_id|src_id'|a_column=='observation_concept_id|src_id')

distinct_concepts<-distinct_concepts21%>%group_by(vocabulary_id.x)%>%count()

colnames(distinct_concepts)<-c('vocabulary_id',  'DE_count')

# Total DEs in tables
tbl_distinct_concepts<-length(distinct_concepts21$stratum_1)
distinct_values<-achillies4_cnt2%>%group_by(stratum_2)%>%count()


# DE Concepts by vocab
distinct_concepts$DE_percentage<-distinct_concepts$DE_count/tbl_distinct_concepts
distinct_concepts5<-distinct_concepts[with(distinct_concepts, order( -DE_percentage)),]



#S1-DE overview
pvs_de<-achillies9%>%group_by(a_table, test_concept_id)%>%count()
vocab_pvs_de<-achillies9%>%group_by(a_table, test_concept_id, value_vocabulary_id)%>%count()
vocab_pvs_de2<-vocab_pvs_de%>%group_by(a_table, test_concept_id)%>%count()
vocab_pvs_de3<-left_join(vocab_pvs_de2,aou_concept, by=c('test_concept_id' = 'concept_id') )%>%select(1:4, 6)
colnames(vocab_pvs_de3)<-c('Table', 'test_concept_id', 'PV_vocabs_used', 'test_name', 'test_vocab')

#PV Vocab usage
full_pvs<-left_join(vocab_pvs_de3,pvs_de, by =c('test_concept_id' ,'Table'='a_table'))
colnames(full_pvs)[6]<-'Distinct_PVs'
colnames(full_pvs)[3]<-'PV_vocabs_used'
vocab_pvs_de<-vocab_pvs_de%>%arrange(-n)

#S1-concitnuation
pv_vocabs_coll<-aggregate(vocab_pvs_de, list(vocab_pvs_de$a_table,vocab_pvs_de$test_concept_id), paste, collapse="|")
full_pvs2<-left_join(full_pvs, pv_vocabs_coll, by=c('Table'='Group.1', 'test_concept_id'='Group.2'))%>%select(,c(1:6,9,10))
full_pvs2$pv_de_vocab_match<-full_pvs2$test_vocab==full_pvs2$value_vocabulary_id
colnames(full_pvs2)[9]<-'DEs_by_vocab'
test_level<-achillies9 [!duplicated(achillies9[c('a_table','a_column', 'test_concept_id')]),]
full_pvs3<-left_join(full_pvs2, test_level, by=c('Table'='a_table', 'test_concept_id'))%>%select(,c(2:10,15,20,23,25))
full_pvs3<-full_pvs3%>%arrange(-per_total_pt)



pv_over<-aggregate(achillies9$count_value, by=list(value_conceppt_id=achillies9$value_conceppt_id), FUN=sum)
pv_over2<-left_join(pv_over, aou_concept,by=c('value_conceppt_id'= 'concept_id'))%>%select(,c(1:3,5,8))
colnames(pv_over2)[2]<-'count_value'
pv_over2<-pv_over2[with(pv_over2, order( -count_value)),]

# Write files
S1<-full_pvs3%>%filter(pt_count_test>19)
S1_2<-S1[,c(2:14)]
S1_2 %>% write_csv('S3_AOU_PPI_DE.csv')

S2<-achillies9%>%filter(pt_count_value>19 )
S2_1<-S2%>%arrange(-pt_count_test)
S2_1 %>% write_csv('S4_AOU_PPI_DE-PV_combinations.csv')


```

# PPI/CRF Data Eleements
## S3-PPI/CRF Data Elements
### PPI/CRF DEs
```{r S3-ppi, message=FALSE, echo=FALSE}
full_pvs4<-full_pvs3%>%filter(pt_count_test>19)
full_pvs4<-full_pvs4%>%arrange(-pt_count_test)
full_pvs5<-full_pvs4[,c(2:14)]
full_pvs5 %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```


### PPI DE Terminologies
```{r T2-ppi, message=FALSE, echo=FALSE}
library(knitr)

colnames(distinct_concepts)<-c('Vocabulary_id', 'DE_count', 'DE_proportion')
kable(distinct_concepts)
```


## S4-PPI/CRF Data Element - Permissable Value Combinations
###  DE-PV combinations
```{r S4-ppi, message=FALSE, echo=FALSE}
achillies99<-achillies9%>%filter(pt_count_value>19 )
achillies99<-achillies99%>%arrange(-pt_count_test)


achillies99 %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```





```















