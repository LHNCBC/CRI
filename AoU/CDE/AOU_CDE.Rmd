---
title: "AllofUS Common Data Elements"
output:
  html_document:
    df_print: paged
    toc: yes

  pdf_document:
    toc: yes

---
*Craig Mayer, Nick Williams, Vojtech Huser*  
*Lister Hill National Center for Biomedical Communications, National Library of Medicine, NIH, Bethesda, MD*


This report contains a subset of data elements and permissable values. For the complete set visit the project repository  at https://github.com/lhncbc/CRI/tree/master/AoU/CDE

---
```{r libraries, message=FALSE, echo=FALSE}
#Load Libraries
library(dplyr)
library(tidyverse)
library(stringr)
library(readr)
library(DT)
library(writexl)

```





```{r DataLoad, message=FALSE, echo=FALSE}
#Load Libraries

#Load concept and workbench extract and combine
aou_concept <- readRDS("aou_concept2.rds")
achillies0 <- readRDS("achillies2_20JAN21.rds")
achillies2<-left_join(achillies0 , aou_concept,by=c('stratum_1'='concept_id'))
achillies3<-left_join(achillies2 , aou_concept,by=c('stratum_2'='concept_id'))
achillies4<- achillies3 #%>% select(,c(1:6,10, 12:14, 16,19:20,22,25))
```


```{r code, message=FALSE, echo=FALSE}

#Filter by analysis type
achillies4_cnt<-achillies4%>%filter(a_type=='cnt')
achillies4_cnt2<-achillies4%>%filter(a_type=='cnt2')


#CObine to have value and test counts in same rows
achillies5<-left_join(achillies4_cnt2, achillies4_cnt, by =c('a_table', "stratum_1"))

#Remove source value columns
achillies6<-achillies5%>%filter(!grepl("source",a_column.y))%>%filter(!grepl("source",a_column.x))
achillies7<-achillies6%>%filter(!grepl("type",a_column.y))%>%filter(!grepl("type",a_column.x))

# Proportion of value count to test count
achillies7$proportion_of_values<-achillies7$count_value.x/achillies7$count_value.y


# Repeat with participant counts
achillies4_cntpt<-achillies4%>%filter(a_type=='cntpt')
achillies4_cnt2pt<-achillies4%>%filter(a_type=='cnt2pt')
achillies5pt<-left_join(achillies4_cnt2pt, achillies4_cntpt, by =c('a_table', "stratum_1"))
achillies6pt<-achillies5pt%>%filter(!grepl("source",a_column.y))
achillies7pt<-achillies6pt%>%filter(!grepl("type",a_column.y))
achillies7pt$proportion_of_values<-achillies7pt$count_value.x/achillies7pt$count_value.y

#Combine overall counts with participant counts
achillies8<-left_join(achillies7,achillies7pt, by=c('a_table', 'stratum_1', 'stratum_2.x') )

achillies9<-achillies8%>%select(,c(1:2,5:6,10, 12,15, 16,18,21, 4,24, 41,44, 62, 79) )
colnames(achillies9)<-c('a_table', 'a_column', 
                        'test_concept_id', 'value_concept_id', 'test_concept_name', 'test_vocabulary_id', 'test_code',
                        'value_concept_name', 'value_vocabulary_id', 'value_code',
                        'count_value', 'count_test','percent', 'pt_count_value', 'pt_count_test','pt_percent')

#Total participants
person<-achillies4%>%filter(a_table=='person')
patients<-person$count_value
achillies9$per_total_pt<-achillies9$pt_count_test/patients

#Comparison of DE and value vocabularies
achillies9$vocab_equivalent<-achillies9$test_vocabulary_id==achillies9$value_vocabulary_id



# Distinct DE  counts by vocabualry  by table
distinct_concepts<-achillies4_cnt%>%group_by(a_table,a_column,vocabulary_id.x)%>%count()
distinct_concepts2<-distinct_concepts%>% filter(a_table=='measurement'|a_table=='observation')
distinct_concepts3<-distinct_concepts2%>% filter(a_column=='measurement_concept_id'|a_column=='observation_concept_id')
colnames(distinct_concepts3)<-c('Table', 'column', 'Vocabulary', 'Distinct_test_concepts')

# Total DEs in tables
tbl_distinct_concepts<-achillies4_cnt%>%group_by(a_table,a_column)%>%count()
distinct_values<-achillies4_cnt2%>%group_by(stratum_2)%>%count()


# DE Concepts by vocab
distinct_concepts4<-left_join(distinct_concepts3, tbl_distinct_concepts, by =c('Table'='a_table','column'='a_column'))
distinct_concepts4$DE_percentage<-distinct_concepts4$Distinct_test_concepts/distinct_concepts4$n
colnames(distinct_concepts4)[5]<-'tbl_DEs_cnt'
distinct_concepts5<-distinct_concepts4[with(distinct_concepts4, order(Table, -DE_percentage)),]



#S1-DE overview
pvs_de<-achillies9%>%group_by(a_table, test_concept_id)%>%count()
vocab_pvs_de<-achillies9%>%group_by(a_table, test_concept_id, value_vocabulary_id)%>%count()
vocab_pvs_de2<-vocab_pvs_de%>%group_by(a_table, test_concept_id)%>%count()
vocab_pvs_de3<-left_join(vocab_pvs_de2,aou_concept, by=c('test_concept_id' = 'concept_id') )%>%select(1:4, 6)
colnames(vocab_pvs_de3)<-c('Table', 'test_concept_id', 'PV_vocabs_used', 'test_name', 'test_vocab')

#PV Vocab usage
full_pvs<-left_join(vocab_pvs_de3,pvs_de, by =c('test_concept_id' ,'Table'='a_table'))
colnames(full_pvs)[6]<-'Distinct_PVs'
colnames(full_pvs)[3]<-'PV_vocabs_used'
vocab_pvs_de<-vocab_pvs_de%>%arrange(-n)

#S1-concitnuation
pv_vocabs_coll<-aggregate(vocab_pvs_de, list(vocab_pvs_de$a_table,vocab_pvs_de$test_concept_id), paste, collapse="|")
full_pvs2<-left_join(full_pvs, pv_vocabs_coll, by=c('Table'='Group.1', 'test_concept_id'='Group.2'))%>%select(,c(1:6,9,10))
full_pvs2$pv_de_vocab_match<-full_pvs2$test_vocab==full_pvs2$value_vocabulary_id
colnames(full_pvs2)[9]<-'DEs_by_vocab'
test_level<-achillies9 [!duplicated(achillies9[c('a_table','a_column', 'test_concept_id')]),]
full_pvs3<-left_join(full_pvs2, test_level, by=c('Table'='a_table', 'test_concept_id'))%>%select(,c(1:2, 4,5, 14,19, 22, 24, 3,6) )
full_pvs3<-full_pvs3%>%arrange(-per_total_pt)

dict<-read_csv('AOU_dictionary3.csv')
s1_0<-left_join(full_pvs3, dict, by =c("test_concept_id"='Question'))

pv_over<-aggregate(achillies9$count_value, by=list(value_conceppt_id=achillies9$value_conceppt_id), FUN=sum)
pv_over2<-left_join(pv_over, aou_concept,by=c('value_conceppt_id'= 'concept_id'))%>%select(,c(1:3,5,8))
colnames(pv_over2)[2]<-'count_value'
pv_over2<-pv_over2[with(pv_over2, order( -count_value)),]




pv_counts<-achillies9%>%filter(percent>0.01)%>%arrange(-count_value)
pv_counts$percent<-round(pv_counts$percent,digits=3)
pv_counts2<-aggregate(pv_counts, list(pv_counts$a_table,pv_counts$test_concept_id), paste, collapse="|")
pv_counts3<-pv_counts2%>%select(,c(1:2, 6,10, 15))
s1_pv<-left_join(s1_loinc, pv_counts3, by =c('Table'='Group.1', 'test_concept_id'='Group.2') )




# Write files
S1<-s1_pv%>%filter(pt_count_test>19)
S1 %>% write_xlsx('S1_AOU_DE.xlsx')
s1_pv %>% write_xlsx('Internal_S1_AOU_DE.xlsx')


CRF2<-CRF%>%select(,c(1:2, 5))
s2_crf<-left_join(achillies9,CRF2, by =c('a_table', 'test_concept_id'='stratum_1'))%>%select(,c(1:19))
colnames(s2_crf)[19]<-'CRF_flag'
s2_crf<- within(s2_crf, CRF_flag[CRF_flag != 'NA'] <- '1')
s2_0<-left_join(s2_crf, dict, by =c("test_concept_id"='Question'))

s2_00<-s2_0 [!duplicated(s2_0[c('a_table', 'test_concept_id','value_concept_id')]),]

S2_01<-s2_00%>%arrange(-count_value)
S2<-achillies9%>%filter(pt_count_value>19 )
S2_1<-S2%>%arrange(-pt_count_test)
S2_1 %>% write_xlsx('S2_AOU_DE-PV_combinations.xlsx')



S2_2<-S2_01%>%arrange(-pt_count_test)
S2_2 %>% write_xlsx('Internal-S2_AOU_DE-PV_combinations.xlsx')

crf_des<-s1_pv%>%filter(CRF_flag==1 & test_vocab=='LOINC')
meth<-crf_des%>%group_by(METHOD_TYP)%>%count()
meth%>%write_csv('aou_CRF_commonCDEs.csv')
```



# Research Data Eleements
## S-Data Elements

```{r S-CRF_DEs, message=FALSE, echo=FALSE}
s1_r<-S1%>%filter(CRF_flag==1)
s1_r %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```


## S-Data Element - Permissable Value Combinations
```{r S2-crf, message=FALSE, echo=FALSE}
s2_r<-S2_1%>%filter(CRF_flag==1)
s2_r %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))


```



# EHR Data Eleements
## S-Data Elements

```{r S-CRF_DEs, message=FALSE, echo=FALSE}
s1_ehr<-S1%>%filter(is.na(CRF_flag))
s1_ehr2<-s1_ehr[1:2500,]

s1_ehrr2 %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))
```


## S-Data Element - Permissable Value Combinations
```{r S2-m, message=FALSE, echo=FALSE}
s2_ehr<-S2_1%>%filter(is.na(CRF_flag))
s2_ehr2<-s2_ehr[1:2500,]

s2_ehr %>% datatable(escape=FALSE,  filter = list(position = 'top', clear = FALSE),options = list(
    search = list(regex = TRUE, caseInsensitive = FALSE)))


```


